const unauthorizedErrorMessage = `
  Unauthorized access. Please login or add http request header {"Authorization":"Bearer <tokenString>"}
`;

export default function accessControl(fun) {
  const handleApply = {
    functionName: fun.name,
    apply: function(target, thisArg, argumentsList) {
      let [, params, ctx] = argumentsList;
      if (!ctx.user) {
        throw new Error(unauthorizedErrorMessage);
      }
      if (ctx.blacklist) {
        const wasLoggedOut = ctx.blacklist.find(
          (item) => item.token === ctx.token
        );
        if (wasLoggedOut) throw new Error(unauthorizedErrorMessage);
      }
      return target({ ...params, ctx });
    },
  };
  return new Proxy(fun, handleApply);
}
